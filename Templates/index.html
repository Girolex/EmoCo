<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>EmoCo Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="chat-container">
        <h2>EmoCo</h2>

        <div id="chat-box" class="chat-box"></div>

        <form id="chat-form">
            <input type="text" id="user-input" name="message" placeholder="Type your message..." autocomplete="off">
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        // --- Initialization and DOM element caching ---
        const form = document.getElementById("chat-form");
        const input = document.getElementById("user-input");
        const chatBox = document.getElementById("chat-box");
        const thinkSound = new Audio("{{ url_for('static', filename='sounds/think.mp3') }}");
        const answerSound = new Audio("{{ url_for('static', filename='sounds/answer.mp3') }}");

        // --- Helper Functions ---

        // --- Welcome message ---
        function addWelcomeMessage() {
            const welcomeDiv = document.createElement("div");
            welcomeDiv.classList.add("bot-msg");
            welcomeDiv.innerHTML = `
    <b>EmoCo:</b> Hello! I'm <b>EmoCo</b> — your music production assistant. 
    I’m here to help you with songwriting, arranging, mixing concepts, and music theory guidance 
    across various skill levels. 
    <br><br>
    Type a message below to start exploring your sound!
`;
            chatBox.appendChild(welcomeDiv);
            updateShadow();
        }

        // --- Scroll shadow management ---
        // Adds/removes shadow classes based on scroll position to enhance UI feedback
        function updateShadow() {
            const canScroll = chatBox.scrollHeight > chatBox.clientHeight;
            const atTop = chatBox.scrollTop <= 0;
            const atBottom = chatBox.scrollTop + chatBox.clientHeight >= chatBox.scrollHeight - 1;

            if (canScroll && !atTop) {
                chatBox.classList.add("scrollable-top");
            } else {
                chatBox.classList.remove("scrollable-top");
            }

            if (canScroll && !atBottom) {
                chatBox.classList.add("scrollable-bottom");
            } else {
                chatBox.classList.remove("scrollable-bottom");
            }
        }

        // --- Initialization on DOMContentLoaded ---
        window.addEventListener("DOMContentLoaded", () => {
            addWelcomeMessage();

            // Update shadow on mutations and scroll
            new MutationObserver(updateShadow).observe(chatBox, { childList: true, subtree: true });
            chatBox.addEventListener("scroll", updateShadow);
        });

        // --- Message submission and response handling ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            thinkSound.currentTime = 0;
            thinkSound.play();

            const message = input.value.trim();
            if (!message) return;

            // Collect the last two visible messages (user-msg and bot-msg) from chatBox for history
            const messages = Array.from(chatBox.querySelectorAll(".user-msg, .bot-msg"));
            const lastTwoMessages = messages.slice(-2).map(el => el.textContent.trim()).join("\n");
            const history = lastTwoMessages;

            // Clear chat box before displaying new messages to restore animations
            chatBox.innerHTML = "";

            // Display user message
            chatBox.innerHTML += `<div class="user-msg">${message}</div>`;
            input.value = "";

            // Show typing indicator
            const typingDiv = document.createElement("div");
            typingDiv.classList.add("bot-msg", "typing");
            typingDiv.innerHTML = `<b>EmoCo:</b> <span class="dots"></span>`;
            chatBox.appendChild(typingDiv);

            // Send message and history to backend and await response

            const response = await fetch("/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ message, history })
            });

            const data = await response.json();

            thinkSound.pause();
            thinkSound.currentTime = 0;
            answerSound.currentTime = 0;
            answerSound.play();

            // Replace typing indicator with bot response, animating lines with fade-in effect
            typingDiv.remove();

            const botDiv = document.createElement("div");
            botDiv.classList.add("bot-msg");

            const lines = data.response.split(/\n|<br\s*\/?>/).filter(line => line.trim() !== "");

            lines.forEach((line, index) => {
                const span = document.createElement("span");
                span.classList.add("fade-in-line");
                span.style.display = "block";
                span.style.animationDelay = `${index * 0.25}s`;
                span.innerHTML = line.trim();
                botDiv.appendChild(span);
            });

            chatBox.appendChild(botDiv);
            chatBox.scrollTop = 0;
            updateShadow();
        });
    </script>
</body>

</html>